<#@ template language="C#" #>
<#@ assembly name="System.Core" #>
<#@ import namespace="System.Linq" #>
<#@ import namespace="System.Text" #>
<#@ import namespace="System.Collections.Generic" #>

SELECT
<# 
foreach (var keyColumn in this.KeyColumns) 
{ 
#>
<#= SQL.Column(this.Table, keyColumn) #>,
<# 
} 
#>
<# 
{
    var index = 0;
    foreach (var value in this.Values) 
    {
        if (index > 0) { #>,<# }#>
<#= SQL.String(value) #> AS "Key_<#= index #>"
<# 
        foreach (var nameColumn in this.NameColumns) 
        {
            foreach (var valueColumn in this.ValueColumns) 
            { 
#>, GROUP_CONCAT
(
    CASE WHEN <#= SQL.Column(this.Table, nameColumn) #> = <#= SQL.String(value) #> 
        THEN <#= SQL.Column(this.Table, valueColumn) #> 
    END
) AS "Value_<#= index #>_<#= valueColumn #>"
<#
            }
        }
        index++;
    }
}
{
    var index = 0;
#> 
FROM <#= SQL.Identifier(this.Table) #> 
GROUP BY
<#
    foreach (var keyColumn in this.KeyColumns)
    {
        if (index > 0) { #>,<# }#>
<#= SQL.Column(this.Table, keyColumn) #>
<#
        index++;
    }
}
#>